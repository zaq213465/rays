$(function(){Metronic.init();Layout.init();QuickSidebar.init();Demo.init();$(".date-picker").datepicker({rtl:Metronic.isRTL(),orientation:"left",autoclose:true});$("#cancle").click(function(){history.go(-1)});selectUtil.initAgent();h();m();o();function o(){k()}$("#agentNo").change(function(){$("#-error").remove();h()});$("#payCode").change(function(){k()});function h(){var i=$("#payCode option")[0];$("#payCode option").remove();$("#payCode").append(i);var j=$("#agentNo").val();if(j==""){return}$.ajax({url:"hasParentPayway",data:"agentNo="+j,type:"POST",async:false,success:function(s){s=$.parseJSON(s);if(s.executeStatus=="0"){var r=s.resultList[0];var q=$("#payCode");$.each(r,function(t,v){var u=$("<option value='"+t+"'>"+v+"</option>");q.append(u)})}else{$("#agentNo").parent().parent().append('<label id="'+name+'-error" class="error" for="'+name+'">当前代理商的上级机构没有设置支付方式</label>')}}})}function m(){var i=$("#payCodeVal").val();$('#payCode option[value="'+i+'"]').attr("selected","selected");if(i!=""){$("#payCode").attr("disabled","disabled")}}function k(){var j=$("#agentNo").val();var i=$("#payCode").val();var q=$("#id").val();if(j==""||i==""){return}$.ajax({url:"hasParentRate",data:{agentNo:j,payCode:i},type:"POST",async:false,success:function(s){s=$.parseJSON(s);if(s.executeStatus=="0"){var r=s.resultMap;$.each(r,function(t,u){if(t=="t0"){$("#t0").val(u)}if(t=="t1"){$("#t1").val(u)}if(t=="rat"){$("#rat").val(u)}});if(q==""){$("#payCode").attr("disabled",false);$("#agentNo").attr("disabled",false)}else{$("#payCode").attr("disabled","disabled");$("#agentNo").attr("disabled","disabled")}}}})}function e(){var q=$("#agentNo").val();var j=$("#payCode").val();var r=$("#id").val();var i=false;$.ajax({url:"check",data:{agentNo:q,payCode:j,id:r},type:"POST",async:false,success:function(s){s=$.parseJSON(s);i=s.check}});return i}function p(){var t=$("#agentNoVal").val();var i=$("#t0Rate").val();var s=$("#t1Rate").val();var r=$("#rate").val();var q=$("#payCode").val();var j=false;$.ajax({url:"checkMerchantRate",data:{agentNo:t,t0Rate:i,t1Rate:s,rate:r,payCode:q},type:"POST",async:false,success:function(u){u=$.parseJSON(u);j=u.check}});return j}$.validator.addMethod("isMobile",function(r,j){var q=r.length;var i=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(j)||(q==11&&i.test(r))},"请正确填写您的手机号码");$.validator.addMethod("isLegalCard",function(q,j){var i=/^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/;return this.optional(j)||(i.test(q))},"身份证格式错误");$.validator.addMethod("isNumTwo",function(q,j){var i=/^[0]$|^0\.[0-9]{1,5}$/;return this.optional(j)||(i.test(q))},"请输入0~1之间的小数，且最多五位小数!");$.validator.addMethod("isNum",function(q,j){var i=/^0\.[0-9]{1,5}$/;return this.optional(j)||(i.test(q))},"请输入0~1之间的小数，且最多五位小数!");$("#form").validate({event:"blur",rules:{agentNo:{required:true,maxlength:25},agentName:{required:true,maxlength:25},payCode:{required:true,maxlength:25},payName:{required:true,maxlength:25},t0Rate:{required:true,maxlength:25,isNumTwo:true},t1Rate:{required:true,maxlength:25,isNum:true},rate:{required:true,maxlength:25},rateAmount:{required:true,maxlength:25}},messages:{agentNo:{required:"请输入【代理商编号】",maxlength:"长度不能超过25"},agentName:{required:"请输入【代理商名称】",maxlength:"长度不能超过25"},payCode:{required:"请输入【支付通道代码】",maxlength:"长度不能超过25"},payName:{required:"请输入【支付通道名称】",maxlength:"长度不能超过25"},t0Rate:{required:"请输入【T0费率】",maxlength:"长度不能超过25"},t1Rate:{required:"请输入【T1费率】",maxlength:"长度不能超过25"},rate:{required:"请输入【提现手续费率】",maxlength:"长度不能超过25"},rateAmount:{required:"请输入【固定手续费金额】",maxlength:"长度不能超过25"}},submitHandler:function(i){var w=0;var v="";if(e()!=true){w++;v+="代理商已存在该支付方式<br>"}var s=$("#t0").val();var r=$("#t1").val();var y=$("#rat").val();var q=$("#t0Rate").val();var j=$("#t1Rate").val();var u=$("#rate").val();if(j<r){w++;v+="t1交易费率必须大于等于上级机构<br>"}if((parseFloat(q)+parseFloat(j)).toFixed(5)<(parseFloat(s)+parseFloat(r)).toFixed(5)){w++;v+="t0,t1之和必须大于等于上级机构之和<br>"}if(u<y){w++;v+="提现手续费必须大于等于上级机构<br>"}if(p()!=true){w++;v+="代理商的交易费率和垫资成本、提现手续费不能大于商戶的<br>"}if(w==0){$("#save").attr("disabled","disabled");var t=$("#baseUrl").text().trim();var x=$("#form").serialize();$.ajax({url:t+"/adminManage/agentpayway/save",data:x,type:"POST",success:function(z){z=$.parseJSON(z);bootbox.alert(z.values,function(){if(z.executeStatus=="0"){location.href=t+z.url}})}})}else{bootbox.alert(v,function(){})}return false},errorPlacement:function(i,j){i.appendTo(j.parent().parent())}});var n=$("select.form-control");for(var g=0;g<n.size();g++){var l=$(n[g]);var a=l.attr("id");var c=$("."+a).val();var b=l.find("option");for(var f=0;f<b.size();f++){var d=$(b[f]).val();if(d==c){$(b[f]).attr("selected","selected")}else{$(b[f]).removeClass("selected")}}}});